{% macro kv(record, section) %}

<div>
{% if g.user.has_seat and record._status == section and g.user in record._lifecycle[record._status]['users'] %}

  {% for entry in record._layout()[section] %}
  <div class="d-lg-flex">
    <div class="title w-lg-25">
      <label class="mt-1">{{ entry['name'] }}</label>
    </div>
    <div class="body ms-3 w-lg-100 d-flex on-hover vis-toggle-{{ entry['value'] }}-{{ loop.index0 }} toggle-target-class" data-toggle-target="vis-toggle-{{ entry['value'] }}-{{ loop.index0 }}">
      <div>
        {% if entry.get('kind')=='multi' %} 
        <div id="display-value-{{ entry['value'] }}-{{ loop.index0 }}">{{ record | attr(entry['value']) | safe }}</div>
        {% elif entry.get('kind')=='dropdown' %}
        <p id="display-value-{{ entry['value'] }}-{{ loop.index0 }}">{{ entry['values'].get(record | attr(entry['value']), '') }}</p>
        {% elif entry.get('kind')=='user' %}
        <p id="display-value-{{ entry['value'] }}-{{ loop.index0 }}">{{ (record | attr(entry['value'])).name }}</p>
        {% else %}
        <p id="display-value-{{ entry['value'] }}-{{ loop.index0 }}">{{ record | attr(entry['value']) }}</p>
        {% endif %}
      </div>
      <div class="ms-auto on-hover-show">
        <i class="fas fa-pen fa-fw"></i>
      </div>
    </div>
    <div class="body ms-3 w-lg-100 d-flex on-hover vis-toggle-{{ entry['value'] }}-{{ loop.index0 }} d-none">
      <form id="form-update-{{ entry['value'] }}-{{ loop.index0 }}" action="{{ record.permalink }}" method="post" class="toasted w-100 me-4">
        <input type="hidden" name="csrf_token" value="{{ g.user.csrf_token }}">
        {% if entry.get('kind')=='multi' %} 
        <textarea id="input-update-{{ entry['value'] }}-{{ loop.index0 }}" class="form-control" name="{{ entry['value'] }}">{{ record.__dict__.get(entry['raw']) }}</textarea>
        {% elif entry.get('kind')=='dropdown' %}
        <select id="input-update-{{ entry['value'] }}-{{ loop.index0 }}" class="form-select" name="{{ entry['value'] }}">
          <option disabled>{{_("Select One")}}</option>
          {% for x in entry['values'] %}
          <option value="{{ x }}" {% if x==record.__dict__.get(entry['value']) %}selected{% endif %}>{{ entry['values'][x] }}</option>
          {% endfor %}
        </select>
        {% elif entry.get('kind')=='user' %}
        <select id="input-update-{{ entry['value'] }}-{{ loop.index0 }}" class="form-select" name="{{ entry['value'] }}">
          <option value="">-{{_("None")}}-</option>
          {% for user in g.user.organization.assignable_users %}
          <option value="{{ user.id }}" {% if user.id==(record | attr(entry['value']+'_id')) %}selected{% endif %}>{{ user.name }}</option>
          {% endfor %}
        </select>
        {% else %}
        <input id="input-update-{{ entry['value'] }}-{{ loop.index0 }}" class="form-control" type="text" name="{{ entry['value'] }}" value="{{ record.__dict__.get(entry['value']) }}">
        {% endif %}
        {% if entry.get('help') %}
        <p class="text-small">{{ entry['help'] }}</p>
        {% endif %}
      </form>
      <a href="javascript:void(0)" class="btn btn-secondary toggle-target-class ms-auto mb-auto" data-toggle-target="vis-toggle-{{ entry['value'] }}-{{ loop.index0 }}">Cancel</a>
      <a href="javascript:void(0)" class="btn btn-primary toggle-target-class record-value-edit ms-2 mb-auto" data-toggle-target="vis-toggle-{{ entry['value'] }}-{{ loop.index0 }}" data-form="form-update-{{ entry['value'] }}-{{ loop.index0 }}" data-value-target="display-value-{{ entry['value'] }}-{{ loop.index0 }}" data-approvals-target="container-approvals-{{ section }}">Save</a>
    </div>
  </div>
  {% endfor %}

{% else %}

  {% for entry in record._layout()[section] %}
  <div class="d-lg-flex">
    <div class="title w-lg-25">
      <label class="mt-1">{{ entry['name'] }}</label>
    </div>
    <div class="body ms-3 w-lg-100 d-flex on-hover vis-toggle-{{ entry['value'] }}-{{ loop.index0 }}">
      <div>
        {% if entry.get('kind')=='multi' %} 
        <div id="display-value-{{ entry['value'] }}-{{ loop.index0 }}">{{ record.__dict__.get(entry['value']) | safe }}</div>
        {% elif entry.get('kind')=='dropdown' %}
        <p id="display-value-{{ entry['value'] }}-{{ loop.index0 }}">{{ entry['values'].get(record.__dict__.get(entry['value']), '') }}</p>
        {% elif entry.get('kind')=='user' %}
        <p id="display-value-{{ entry['value'] }}-{{ loop.index0 }}">{{ (record | attr(entry['value'])).name }}</p>
        {% else %}
        <p id="display-value-{{ entry['value'] }}-{{ loop.index0 }}">{{ record.__dict__.get(entry['value']) }}</p>
        {% endif %}
      </div>
    </div>
  </div>
  {% endfor %}

{% endif %}

  {% if record.phase_approvals(section) %}
  <div id="container-approvals-{{ section }}" class="d-lg-flex">
    <div class="title w-lg-25">
      <label class="mt-1">{{ _("Approvals") }}</label>
    </div>
    <div class="body ms-3 w-lg-100 d-flex">
      {% for approval in record.phase_approvals(section) %}
      <div>
        <button class="btn btn-success m-1"><i class="fas fa-signature me-2"></i>{{ approval.user.name }} | {{ approval.created_datetime }}</button>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

</div>

{% endmacro %}